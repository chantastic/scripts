#!/usr/bin/env python3
"""
Add B-roll markers to an OTIO timeline

Detects proper nouns in clip transcripts and adds B-roll markers.

Usage:
    add-broll <otio_path>

Example:
    add-broll my-video.otio
"""

import argparse
import sys
from pathlib import Path

try:
    import opentimelineio as otio
except ImportError:
    print("Error: opentimelineio required. Install with: pip install opentimelineio")
    sys.exit(1)

from rc_broll import detect_proper_nouns


def main():
    parser = argparse.ArgumentParser(description='Add B-roll markers to OTIO timeline')
    parser.add_argument('otio_path', help='Path to .otio file')

    args = parser.parse_args()

    otio_path = Path(args.otio_path).resolve()
    if not otio_path.exists():
        print(f"Error: {otio_path} not found")
        sys.exit(1)

    print(f"Loading: {otio_path.name}")
    timeline = otio.adapters.read_from_file(str(otio_path))

    track = timeline.tracks[0]
    fps = timeline.metadata.get("rough-cut", {}).get("fps", 30)

    broll_count = 0
    for clip in track:
        if not isinstance(clip, otio.schema.Clip):
            continue

        text = clip.metadata.get("rough-cut", {}).get("transcript", "")
        proper_nouns = detect_proper_nouns(text)

        for noun in proper_nouns:
            marker = otio.schema.Marker(
                name=f"B-roll: {noun}",
                marked_range=otio.opentime.TimeRange(
                    start_time=otio.opentime.RationalTime(0, fps),
                    duration=otio.opentime.RationalTime(1, fps)
                ),
                color=otio.schema.MarkerColor.GREEN,
                metadata={
                    "rough-cut": {
                        "type": "broll",
                        "noun": noun,
                    }
                }
            )
            clip.markers.append(marker)
            broll_count += 1

    otio.adapters.write_to_file(timeline, str(otio_path))
    print(f"Added {broll_count} B-roll markers")
    print(f"Updated: {otio_path}")


if __name__ == '__main__':
    main()
